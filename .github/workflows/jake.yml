name: FluxGen Test Pipeline (Mock)

on:
  workflow_dispatch:
    inputs:
      prd_json:
        description: 'PRD JSON (stringified)'
        required: true
        type: string
      project_id:
        description: 'FluxGen Project ID'
        required: true
        type: string
      callback_url:
        description: 'Webhook URL for status updates'
        required: true
        type: string
      step_delay:
        description: 'Seconds per step (default: 30)'
        required: false
        default: '30'
        type: string
      max_loops:
        description: 'Maximum loops (default: 2)'
        required: false
        default: '2'
        type: string
      ai_provider:
        description: 'AI Provider (ignored in test mode)'
        required: false
        default: 'anthropic'
        type: string

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: pip install requests

      - name: Write PRD
        env:
          PRD_JSON: ${{ inputs.prd_json }}
        run: python3 -c "import os; open('prd.json', 'w').write(os.environ['PRD_JSON'])"

      - name: Write mock pipeline script
        run: |
          echo "IyEvdXNyL2Jpbi9lbnYgcHl0aG9uMwoiIiJGbHV4R2VuIFBpcGVsaW5lIC0gTU9DSyBWRVJTSU9OIGZvciB0ZXN0aW5nIFVJL3dlYmhvb2tzIiIiCmltcG9ydCBvcywgc3lzLCBqc29uLCB0aW1lLCBzdWJwcm9jZXNzLCByZXF1ZXN0cwpmcm9tIHBhdGhsaWIgaW1wb3J0IFBhdGgKCk1BWF9MT09QUyA9IGludChvcy5nZXRlbnYoJ01BWF9MT09QUycsICcyJykpICAjIEZld2VyIGxvb3BzIGZvciB0ZXN0aW5nCkNBTExCQUNLX1VSTCA9IG9zLmdldGVudignQ0FMTEJBQ0tfVVJMJywgJycpClBST0pFQ1RfSUQgPSBvcy5nZXRlbnYoJ1BST0pFQ1RfSUQnLCAnJykKU1RFUF9ERUxBWSA9IGludChvcy5nZXRlbnYoJ1NURVBfREVMQVknLCAnMzAnKSkgICMgU2Vjb25kcyBwZXIgc3RlcAoKZGVmIGxvZyhtc2cpOgogICAgcHJpbnQobXNnLCBmbHVzaD1UcnVlKQoKZGVmIHNlbmRfd2ViaG9vayhzdGF0dXMsIG1lc3NhZ2UsIGFnZW50PU5vbmUsIHBoYXNlPU5vbmUsIGxvb3BfbnVtYmVyPU5vbmUpOgogICAgaWYgbm90IENBTExCQUNLX1VSTCBvciBub3QgUFJPSkVDVF9JRDogcmV0dXJuCiAgICBwYXlsb2FkID0geydwcm9qZWN0SWQnOiBQUk9KRUNUX0lELCAnc3RhdHVzJzogc3RhdHVzLCAnbWVzc2FnZSc6IG1lc3NhZ2V9CiAgICBpZiBhZ2VudDogcGF5bG9hZFsnYWdlbnQnXSA9IGFnZW50CiAgICBpZiBwaGFzZTogcGF5bG9hZFsncGhhc2UnXSA9IHBoYXNlCiAgICBpZiBsb29wX251bWJlcjogcGF5bG9hZFsnbG9vcE51bWJlciddID0gbG9vcF9udW1iZXIKICAgIHRyeToKICAgICAgICByZXNwID0gcmVxdWVzdHMucG9zdChDQUxMQkFDS19VUkwsIGpzb249cGF5bG9hZCwgdGltZW91dD0xMCwgYWxsb3dfcmVkaXJlY3RzPVRydWUpCiAgICAgICAgcmVzcC5yYWlzZV9mb3Jfc3RhdHVzKCkKICAgICAgICBsb2coZiJbV2ViaG9va10ge2FnZW50IG9yICdzeXN0ZW0nfToge21lc3NhZ2V9IikKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICBsb2coZiJbV2ViaG9va10gRkFJTEVEOiB7ZX0iKQoKZGVmIHNpbXVsYXRlX3dvcmsoYWdlbnRfbmFtZSwgZHVyYXRpb249Tm9uZSk6CiAgICAiIiJTaW11bGF0ZSB3b3JrIHdpdGggYSBkZWxheSIiIgogICAgZGVsYXkgPSBkdXJhdGlvbiBvciBTVEVQX0RFTEFZCiAgICBsb2coZiIgIFt7YWdlbnRfbmFtZX1dIFNpbXVsYXRpbmcgd29yayBmb3Ige2RlbGF5fSBzZWNvbmRzLi4uIikKICAgIHRpbWUuc2xlZXAoZGVsYXkpCiAgICBsb2coZiIgIFt7YWdlbnRfbmFtZX1dIERvbmUhIikKCmRlZiB3cml0ZV9maWxlKHBhdGgsIGNvbnRlbnQpOgogICAgcGF0aC53cml0ZV90ZXh0KGNvbnRlbnQpCiAgICBsb2coZiIgIFtNb2NrXSBDcmVhdGVkIHtwYXRoLm5hbWV9IikKCmRlZiBydW5fbWFyY19wbGFubmluZyhyb290LCBwcmQpOgogICAgbG9nKCJcbiIgKyAiPSIqNjAgKyAiXG7wn5OLIE1BUkMgLSBQbGFubmluZyAoTU9DSylcbiIgKyAiPSIqNjApCiAgICBzZW5kX3dlYmhvb2soJ21hcmNfcGxhbicsICJDcmVhdGluZyBpbXBsZW1lbnRhdGlvbiBwbGFuLi4uIiwgJ21hcmMnLCAnbWFyY19wbGFuJywgMSkKCiAgICBzaW11bGF0ZV93b3JrKCdtYXJjJykKCiAgICAjIENyZWF0ZSBtb2NrIFBMQU4ubWQKICAgIHBsYW5fY29udGVudCA9IGYiIiIjIEltcGxlbWVudGF0aW9uIFBsYW4KCiMjIFByb2plY3Q6IHtwcmQuZ2V0KCdwcm9qZWN0X25hbWUnLCAnVGVzdCBQcm9qZWN0Jyl9CgojIyMgT3ZlcnZpZXcKe3ByZC5nZXQoJ2Rlc2NyaXB0aW9uJywgJ0EgdGVzdCBwcm9qZWN0Jyl9CgojIyMgVGVjaCBTdGFjawotIE5leHQuanMgMTQKLSBUeXBlU2NyaXB0Ci0gVGFpbHdpbmQgQ1NTCgojIyMgRmlsZSBTdHJ1Y3R1cmUKYGBgCi4vCuKUnOKUgOKUgCBwYWNrYWdlLmpzb24K4pSc4pSA4pSAIG5leHQuY29uZmlnLmpzCuKUnOKUgOKUgCBzcmMvCuKUgiAgIOKUnOKUgOKUgCBhcHAvCuKUgiAgIOKUgiAgIOKUnOKUgOKUgCBwYWdlLnRzeArilIIgICDilIIgICDilJTilIDilIAgbGF5b3V0LnRzeArilIIgICDilJTilIDilIAgY29tcG9uZW50cy8K4pSCICAgICAgIOKUlOKUgOKUgCBIZWFkZXIudHN4CuKUlOKUgOKUgCBwdWJsaWMvCmBgYAoKIyMjIEltcGxlbWVudGF0aW9uIFN0ZXBzCjEuIENyZWF0ZSBwYWNrYWdlLmpzb24gd2l0aCBkZXBlbmRlbmNpZXMKMi4gU2V0IHVwIE5leHQuanMgY29uZmlndXJhdGlvbgozLiBDcmVhdGUgbWFpbiBwYWdlIGNvbXBvbmVudAo0LiBBZGQgc3R5bGluZyB3aXRoIFRhaWx3aW5kCjUuIFRlc3QgdGhlIGFwcGxpY2F0aW9uCgojIyMgVXNlciBTdG9yaWVzCntqc29uLmR1bXBzKHByZC5nZXQoJ3N0b3JpZXMnLCBbXSksIGluZGVudD0yKX0KCi0tLQoqR2VuZXJhdGVkIGJ5IEZsdXhHZW4gTW9jayBQaXBlbGluZSoKIiIiCiAgICB3cml0ZV9maWxlKHJvb3QgLyAnUExBTi5tZCcsIHBsYW5fY29udGVudCkKCiAgICBzZW5kX3dlYmhvb2soJ21hcmNfcGxhbicsICJQbGFuIHJlYWR5ISIsICdtYXJjJywgJ21hcmNfcGxhbicsIDEpCiAgICByZXR1cm4gVHJ1ZSwgcGxhbl9jb250ZW50CgpkZWYgcnVuX2pha2VfYnVpbGQocm9vdCwgcHJkLCBwbGFuLCBsb29wLCBxYV9mYj0iIik6CiAgICBsb2coZiJcbnsnPScqNjB9XG7wn5Go4oCN8J+SuyBKQUtFIC0gQnVpbGRpbmcgKExvb3Age2xvb3B9KSAoTU9DSylcbnsnPScqNjB9IikKICAgIHNlbmRfd2ViaG9vaygnamFrZV9idWlsZCcsICJCdWlsZGluZy4uLiIgaWYgbG9vcCA9PSAxIGVsc2UgIkZpeGluZyBpc3N1ZXMuLi4iLCAnamFrZScsICdqYWtlX2J1aWxkJywgbG9vcCkKCiAgICBzaW11bGF0ZV93b3JrKCdqYWtlJykKCiAgICAjIENyZWF0ZSBtb2NrIHBhY2thZ2UuanNvbgogICAgcGFja2FnZV9qc29uID0gewogICAgICAgICJuYW1lIjogcHJkLmdldCgncHJvamVjdF9uYW1lJywgJ3Rlc3QtcHJvamVjdCcpLmxvd2VyKCkucmVwbGFjZSgnICcsICctJyksCiAgICAgICAgInZlcnNpb24iOiAiMS4wLjAiLAogICAgICAgICJzY3JpcHRzIjogewogICAgICAgICAgICAiZGV2IjogIm5leHQgZGV2IiwKICAgICAgICAgICAgImJ1aWxkIjogIm5leHQgYnVpbGQiLAogICAgICAgICAgICAic3RhcnQiOiAibmV4dCBzdGFydCIsCiAgICAgICAgICAgICJsaW50IjogIm5leHQgbGludCIKICAgICAgICB9LAogICAgICAgICJkZXBlbmRlbmNpZXMiOiB7CiAgICAgICAgICAgICJuZXh0IjogIjE0LjAuMCIsCiAgICAgICAgICAgICJyZWFjdCI6ICIxOC4yLjAiLAogICAgICAgICAgICAicmVhY3QtZG9tIjogIjE4LjIuMCIKICAgICAgICB9CiAgICB9CiAgICB3cml0ZV9maWxlKHJvb3QgLyAncGFja2FnZS5qc29uJywganNvbi5kdW1wcyhwYWNrYWdlX2pzb24sIGluZGVudD0yKSkKCiAgICAjIENyZWF0ZSBtb2NrIHNyYyBkaXJlY3RvcnkgYW5kIGZpbGVzCiAgICBzcmNfYXBwID0gcm9vdCAvICdzcmMnIC8gJ2FwcCcKICAgIHNyY19hcHAubWtkaXIocGFyZW50cz1UcnVlLCBleGlzdF9vaz1UcnVlKQoKICAgIHdyaXRlX2ZpbGUoc3JjX2FwcCAvICdwYWdlLnRzeCcsIGYnJydleHBvcnQgZGVmYXVsdCBmdW5jdGlvbiBIb21lKCkge3sKICByZXR1cm4gKAogICAgPG1haW4+CiAgICAgIDxoMT57cHJkLmdldCgncHJvamVjdF9uYW1lJywgJ1Rlc3QgUHJvamVjdCcpfTwvaDE+CiAgICAgIDxwPkJ1aWx0IGJ5IEZsdXhHZW4gTW9jayBQaXBlbGluZTwvcD4KICAgIDwvbWFpbj4KICApCn19CicnJykKCiAgICB3cml0ZV9maWxlKHNyY19hcHAgLyAnbGF5b3V0LnRzeCcsICcnJ2V4cG9ydCBkZWZhdWx0IGZ1bmN0aW9uIFJvb3RMYXlvdXQoeyBjaGlsZHJlbiB9KSB7CiAgcmV0dXJuICgKICAgIDxodG1sIGxhbmc9ImVuIj4KICAgICAgPGJvZHk+e2NoaWxkcmVufTwvYm9keT4KICAgIDwvaHRtbD4KICApCn0KJycnKQoKICAgIHNlbmRfd2ViaG9vaygnamFrZV9idWlsZCcsICJCdWlsZCBkb25lISIsICdqYWtlJywgJ2pha2VfYnVpbGQnLCBsb29wKQogICAgcmV0dXJuIFRydWUKCmRlZiBydW5fZG91Z192ZXJpZnkocm9vdCwgbG9vcCk6CiAgICBsb2coZiJcbnsnPScqNjB9XG7wn5SnIERPVUcgLSBWZXJpZnlpbmcgKExvb3Age2xvb3B9KSAoTU9DSylcbnsnPScqNjB9IikKICAgIHNlbmRfd2ViaG9vaygnZG91Z192ZXJpZnknLCAiVmVyaWZ5aW5nIGJ1aWxkLi4uIiwgJ2RvdWcnLCAnZG91Z192ZXJpZnknLCBsb29wKQoKICAgIHNpbXVsYXRlX3dvcmsoJ2RvdWcnKQoKICAgICMgQ3JlYXRlIG1vY2sgQlVJTERfTE9HLm1kCiAgICBidWlsZF9sb2cgPSBmIiIiIyBCdWlsZCBMb2cgLSBMb29wIHtsb29wfQoKIyMgRmlsZXMgRm91bmQKLSBwYWNrYWdlLmpzb24KLSBzcmMvYXBwL3BhZ2UudHN4Ci0gc3JjL2FwcC9sYXlvdXQudHN4Ci0gUExBTi5tZAoKIyMgbnBtIGluc3RhbGwK4pyFIFNpbXVsYXRlZCBzdWNjZXNzCgojIyBucG0gcnVuIGJ1aWxkCuKchSBTaW11bGF0ZWQgc3VjY2VzcwoKIyMgRGV2IFNlcnZlciBUZXN0CuKchSBTZXJ2ZXIgc3RhcnRlZCBvbiBwb3J0IDU1NTUgKHNpbXVsYXRlZCkKCi0tLQoqR2VuZXJhdGVkIGJ5IEZsdXhHZW4gTW9jayBQaXBlbGluZSoKIiIiCiAgICB3cml0ZV9maWxlKHJvb3QgLyAnQlVJTERfTE9HLm1kJywgYnVpbGRfbG9nKQoKICAgIHNlbmRfd2ViaG9vaygnZG91Z192ZXJpZnknLCAiVmVyaWZpZWQhIiwgJ2RvdWcnLCAnZG91Z192ZXJpZnknLCBsb29wKQogICAgcmV0dXJuIFRydWUKCmRlZiBydW5fY29keV9xYShyb290LCBwcmQsIGxvb3ApOgogICAgbG9nKGYiXG57Jz0nKjYwfVxu8J+nqiBDT0RZIC0gUUEgKExvb3Age2xvb3B9KSAoTU9DSylcbnsnPScqNjB9IikKICAgIHNlbmRfd2ViaG9vaygnY29keV9xYScsICJUZXN0aW5nLi4uIiwgJ2NvZHknLCAnY29keV9xYScsIGxvb3ApCgogICAgc2ltdWxhdGVfd29yaygnY29keScpCgogICAgIyBDcmVhdGUgbW9jayBRQV9SRVBPUlQubWQgLSBwYXNzIG9uIGxvb3AgMiwgZmFpbCBvbiBsb29wIDEKICAgIGlmIGxvb3AgPj0gMjoKICAgICAgICBxYV9yZXBvcnQgPSBmIiIiIyBRQSBSZXBvcnQgLSBMb29wIHtsb29wfQoKIyMgU3VtbWFyeTogUEFTUyDinIUKQWxsIHRlc3RzIHBhc3MhIFRoZSBpbXBsZW1lbnRhdGlvbiBtZWV0cyBhbGwgcmVxdWlyZW1lbnRzLgoKIyMgQ3JpdGljYWwgSXNzdWVzCk5vbmUKCiMjIEhpZ2ggSXNzdWVzCk5vbmUKCiMjIE1lZGl1bSBJc3N1ZXMKTm9uZQoKIyMgTG93IElzc3VlcwotIENvbnNpZGVyIGFkZGluZyBtb3JlIHJlc3BvbnNpdmUgc3R5bGVzCgojIyBTdG9yeSBWZXJpZmljYXRpb24Ke2pzb24uZHVtcHMocHJkLmdldCgnc3RvcmllcycsIFtdKSwgaW5kZW50PTIpfQoKQWxsIHVzZXIgc3RvcmllcyB2ZXJpZmllZCEg4pyFCgotLS0KKkdlbmVyYXRlZCBieSBGbHV4R2VuIE1vY2sgUGlwZWxpbmUqCiIiIgogICAgZWxzZToKICAgICAgICBxYV9yZXBvcnQgPSBmIiIiIyBRQSBSZXBvcnQgLSBMb29wIHtsb29wfQoKIyMgU3VtbWFyeTogTkVFRFMgV09SSwoKIyMgQ3JpdGljYWwgSXNzdWVzCk5vbmUKCiMjIEhpZ2ggSXNzdWVzCi0gTWlzc2luZyBwcm9wZXIgZXJyb3IgaGFuZGxpbmcgaW4gcGFnZS50c3gKCiMjIE1lZGl1bSBJc3N1ZXMKLSBObyBsb2FkaW5nIHN0YXRlcyBpbXBsZW1lbnRlZAotIE1pc3NpbmcgbWV0YSB0YWdzCgojIyBMb3cgSXNzdWVzCi0gQ291bGQgdXNlIG1vcmUgY29tbWVudHMKCiMjIFN0b3J5IFZlcmlmaWNhdGlvbgp7anNvbi5kdW1wcyhwcmQuZ2V0KCdzdG9yaWVzJywgW10pLCBpbmRlbnQ9Mil9CgotLS0KKkdlbmVyYXRlZCBieSBGbHV4R2VuIE1vY2sgUGlwZWxpbmUqCiIiIgoKICAgIHdyaXRlX2ZpbGUocm9vdCAvICdRQV9SRVBPUlQubWQnLCBxYV9yZXBvcnQpCgogICAgc2VuZF93ZWJob29rKCdjb2R5X3FhJywgIlFBIGRvbmUhIiwgJ2NvZHknLCAnY29keV9xYScsIGxvb3ApCiAgICByZXR1cm4gVHJ1ZSwgcWFfcmVwb3J0CgpkZWYgcnVuX21hcmNfcmV2aWV3KHJvb3QsIHFhX3JlcG9ydCwgbG9vcCk6CiAgICBsb2coZiJcbnsnPScqNjB9XG7wn5OLIE1BUkMgLSBSZXZpZXdpbmcgKExvb3Age2xvb3B9KSAoTU9DSylcbnsnPScqNjB9IikKICAgIHNlbmRfd2ViaG9vaygnbWFyY19yZXZpZXcnLCAiUmV2aWV3aW5nIFFBLi4uIiwgJ21hcmMnLCAnbWFyY19yZXZpZXcnLCBsb29wKQoKICAgIHNpbXVsYXRlX3dvcmsoJ21hcmMnLCBkdXJhdGlvbj0xNSkgICMgU2hvcnRlciBmb3IgcmV2aWV3CgogICAgIyBVcGRhdGUgUExBTi5tZCB3aXRoIGZpeGVzCiAgICBwbGFuID0gKHJvb3QgLyAnUExBTi5tZCcpLnJlYWRfdGV4dCgpIGlmIChyb290IC8gJ1BMQU4ubWQnKS5leGlzdHMoKSBlbHNlICIiCiAgICB1cGRhdGVkX3BsYW4gPSBwbGFuICsgZiIiIgoKLS0tCiMjIEZpeGVzIGZvciBMb29wIHtsb29wICsgMX0KCkJhc2VkIG9uIFFBIGZlZWRiYWNrOgoxLiBBZGQgZXJyb3IgaGFuZGxpbmcgdG8gcGFnZS50c3gKMi4gSW1wbGVtZW50IGxvYWRpbmcgc3RhdGVzCjMuIEFkZCBtZXRhIHRhZ3MgZm9yIFNFTwoKLS0tCipVcGRhdGVkIGJ5IEZsdXhHZW4gTW9jayBQaXBlbGluZSoKIiIiCiAgICB3cml0ZV9maWxlKHJvb3QgLyAnUExBTi5tZCcsIHVwZGF0ZWRfcGxhbikKCiAgICBzZW5kX3dlYmhvb2soJ21hcmNfcmV2aWV3JywgIlBsYW4gdXBkYXRlZCEiLCAnbWFyYycsICdtYXJjX3JldmlldycsIGxvb3ApCiAgICByZXR1cm4gVHJ1ZSwgdXBkYXRlZF9wbGFuCgpkZWYgcnVuX2Nvbm5vcl9kb2NzKHJvb3QsIHByZCwgbG9vcCk6CiAgICBsb2coZiJcbnsnPScqNjB9XG7wn5OdIENPTk5PUiAtIERvY3MgKE1PQ0spXG57Jz0nKjYwfSIpCiAgICBzZW5kX3dlYmhvb2soJ2Nvbm5vcl9kb2NzJywgIldyaXRpbmcgZG9jcy4uLiIsICdjb25ub3InLCAnY29ubm9yX2RvY3MnLCBsb29wKQoKICAgIHNpbXVsYXRlX3dvcmsoJ2Nvbm5vcicpCgogICAgbmFtZSA9IHByZC5nZXQoJ3Byb2plY3RfbmFtZScsICdUZXN0IFByb2plY3QnKQogICAgZGVzYyA9IHByZC5nZXQoJ2Rlc2NyaXB0aW9uJywgJ0EgdGVzdCBwcm9qZWN0JykKCiAgICByZWFkbWUgPSBmIiIiIyB7bmFtZX0KCntkZXNjfQoKIyMgRmVhdHVyZXMKLSBNb2Rlcm4gTmV4dC5qcyAxNCBhcHBsaWNhdGlvbgotIFR5cGVTY3JpcHQgc3VwcG9ydAotIFRhaWx3aW5kIENTUyBzdHlsaW5nCgojIyBUZWNoIFN0YWNrCi0gTmV4dC5qcyAxNAotIFJlYWN0IDE4Ci0gVHlwZVNjcmlwdAotIFRhaWx3aW5kIENTUwoKIyMgSW5zdGFsbGF0aW9uCgpgYGBiYXNoCm5wbSBpbnN0YWxsCmBgYAoKIyMgRGV2ZWxvcG1lbnQKCmBgYGJhc2gKbnBtIHJ1biBkZXYKYGBgCgpPcGVuIFtodHRwOi8vbG9jYWxob3N0OjMwMDBdKGh0dHA6Ly9sb2NhbGhvc3Q6MzAwMCkgaW4geW91ciBicm93c2VyLgoKIyMgQnVpbGQKCmBgYGJhc2gKbnBtIHJ1biBidWlsZApucG0gc3RhcnQKYGBgCgotLS0KKkJ1aWx0IHdpdGggRmx1eEdlbiBNb2NrIFBpcGVsaW5lKgoiIiIKCiAgICBob3dfdG9fcnVuID0gZiIiIiMgSG93IHRvIFJ1biB7bmFtZX0KCiMjIFByZXJlcXVpc2l0ZXMKLSBOb2RlLmpzIDE4KwotIG5wbSBvciB5YXJuCgojIyBTZXR1cAoKMS4gQ2xvbmUgdGhlIHJlcG9zaXRvcnkKMi4gSW5zdGFsbCBkZXBlbmRlbmNpZXM6CiAgIGBgYGJhc2gKICAgbnBtIGluc3RhbGwKICAgYGBgCgojIyBEZXZlbG9wbWVudAoKUnVuIHRoZSBkZXZlbG9wbWVudCBzZXJ2ZXI6CmBgYGJhc2gKbnBtIHJ1biBkZXYKYGBgCgojIyBQcm9kdWN0aW9uCgpCdWlsZCBhbmQgc3RhcnQ6CmBgYGJhc2gKbnBtIHJ1biBidWlsZApucG0gc3RhcnQKYGBgCgojIyBUcm91Ymxlc2hvb3RpbmcKCi0gSWYgcG9ydCAzMDAwIGlzIGluIHVzZSwgTmV4dC5qcyB3aWxsIHRyeSB0aGUgbmV4dCBhdmFpbGFibGUgcG9ydAotIENsZWFyIGAubmV4dGAgZm9sZGVyIGlmIHlvdSBlbmNvdW50ZXIgYnVpbGQgaXNzdWVzCgotLS0KKkdlbmVyYXRlZCBieSBGbHV4R2VuIE1vY2sgUGlwZWxpbmUqCiIiIgoKICAgIHdyaXRlX2ZpbGUocm9vdCAvICdSRUFETUUubWQnLCByZWFkbWUpCiAgICB3cml0ZV9maWxlKHJvb3QgLyAnSG93X3RvX3J1bi5tZCcsIGhvd190b19ydW4pCgogICAgc2VuZF93ZWJob29rKCdjb25ub3JfZG9jcycsICJEb2NzIGRvbmUhIiwgJ2Nvbm5vcicsICdjb25ub3JfZG9jcycsIGxvb3ApCiAgICByZXR1cm4gVHJ1ZQoKZGVmIHNob3VsZF9jb250aW51ZShxYV9yZXBvcnQpOgogICAgbG93ID0gcWFfcmVwb3J0Lmxvd2VyKCkKICAgIGlmICdhbGwgcGFzcycgaW4gbG93IG9yICdhbGwgdGVzdHMgcGFzcycgaW4gbG93OgogICAgICAgIHJldHVybiBGYWxzZSwgIkFsbCBwYXNzaW5nIgogICAgaWYgJ2NyaXRpY2FsJyBpbiBsb3cgb3IgJ2hpZ2gnIGluIGxvdzoKICAgICAgICByZXR1cm4gVHJ1ZSwgIklzc3VlcyB0byBmaXgiCiAgICByZXR1cm4gRmFsc2UsICJObyBibG9ja2luZyBpc3N1ZXMiCgpkZWYgbWFpbigpOgogICAgcm9vdCA9IFBhdGguY3dkKCkKICAgIHByZF9wYXRoID0gcm9vdCAvICdwcmQuanNvbicKCiAgICBsb2coIvCfmoAgRmx1eEdlbiBQaXBlbGluZSAoTU9DSyBNT0RFIC0gTm8gQUkgQVBJcykiKQogICAgbG9nKGYiICAg4o+x77iPICBTdGVwIGRlbGF5OiB7U1RFUF9ERUxBWX0gc2Vjb25kcyIpCiAgICBsb2coZiIgICDwn5SEIE1heCBsb29wczoge01BWF9MT09QU30iKQoKICAgIGlmIG5vdCBwcmRfcGF0aC5leGlzdHMoKToKICAgICAgICBsb2coIuKdjCBwcmQuanNvbiBub3QgZm91bmQsIGNyZWF0aW5nIG1vY2sgUFJELi4uIikKICAgICAgICBtb2NrX3ByZCA9IHsKICAgICAgICAgICAgInByb2plY3RfbmFtZSI6ICJUZXN0IFByb2plY3QiLAogICAgICAgICAgICAiZGVzY3JpcHRpb24iOiAiQSB0ZXN0IHByb2plY3QgZm9yIFVJIGRldmVsb3BtZW50IiwKICAgICAgICAgICAgIm1vZGUiOiAic2NyYXRjaCIsCiAgICAgICAgICAgICJ0ZWNoX3N0YWNrIjogIk5leHQuanMiLAogICAgICAgICAgICAic3RvcmllcyI6IFsKICAgICAgICAgICAgICAgIHsidGl0bGUiOiAiVXNlciBjYW4gdmlldyBob21lcGFnZSIsICJkZXNjcmlwdGlvbiI6ICJCYXNpYyBob21lcGFnZSBkaXNwbGF5In0sCiAgICAgICAgICAgICAgICB7InRpdGxlIjogIlVzZXIgY2FuIG5hdmlnYXRlIiwgImRlc2NyaXB0aW9uIjogIk5hdmlnYXRpb24gd29ya3MgY29ycmVjdGx5In0KICAgICAgICAgICAgXQogICAgICAgIH0KICAgICAgICBwcmRfcGF0aC53cml0ZV90ZXh0KGpzb24uZHVtcHMobW9ja19wcmQsIGluZGVudD0yKSkKCiAgICBwcmQgPSBqc29uLmxvYWRzKHByZF9wYXRoLnJlYWRfdGV4dCgpKQoKICAgICMgUGhhc2UgMTogUGxhbm5pbmcKICAgIG9rLCBwbGFuID0gcnVuX21hcmNfcGxhbm5pbmcocm9vdCwgcHJkKQogICAgaWYgbm90IG9rOgogICAgICAgIGxvZygi4p2MIFBsYW5uaW5nIGZhaWxlZCIpCiAgICAgICAgc3lzLmV4aXQoMSkKCiAgICAjIFBoYXNlIDI6IEJ1aWxkIGxvb3BzCiAgICBmaW5hbF9sb29wID0gMQogICAgY29tcGxldGUgPSBGYWxzZQogICAgcWFfZmVlZGJhY2sgPSAiIgoKICAgIGZvciBsb29wIGluIHJhbmdlKDEsIE1BWF9MT09QUyArIDEpOgogICAgICAgIGZpbmFsX2xvb3AgPSBsb29wCiAgICAgICAgbG9nKGYiXG7wn5SEIExPT1Age2xvb3B9L3tNQVhfTE9PUFN9IikKICAgICAgICBzZW5kX3dlYmhvb2soJ2xvb3BfaXRlcmF0aW9uJywgZiJMb29wIHtsb29wfSIsICdtYXJjJywgJ2xvb3Bfc3RhcnQnLCBsb29wKQoKICAgICAgICAjIEJ1aWxkCiAgICAgICAgcnVuX2pha2VfYnVpbGQocm9vdCwgcHJkLCBwbGFuLCBsb29wLCBxYV9mZWVkYmFjaykKCiAgICAgICAgIyBWZXJpZnkKICAgICAgICBydW5fZG91Z192ZXJpZnkocm9vdCwgbG9vcCkKCiAgICAgICAgIyBRQQogICAgICAgIF8sIHFhX3JlcG9ydCA9IHJ1bl9jb2R5X3FhKHJvb3QsIHByZCwgbG9vcCkKCiAgICAgICAgIyBDaGVjayBpZiB3ZSBzaG91bGQgY29udGludWUKICAgICAgICBjb250LCByZWFzb24gPSBzaG91bGRfY29udGludWUocWFfcmVwb3J0KQogICAgICAgIGxvZyhmIiAgW1FBXSB7cmVhc29ufSIpCgogICAgICAgIGlmIG5vdCBjb250OgogICAgICAgICAgICBjb21wbGV0ZSA9IFRydWUKICAgICAgICAgICAgYnJlYWsKCiAgICAgICAgIyBSZXZpZXcgYW5kIHVwZGF0ZSBwbGFuIGZvciBuZXh0IGl0ZXJhdGlvbgogICAgICAgIGlmIGxvb3AgPCBNQVhfTE9PUFM6CiAgICAgICAgICAgIF8sIHBsYW4gPSBydW5fbWFyY19yZXZpZXcocm9vdCwgcWFfcmVwb3J0LCBsb29wKQogICAgICAgICAgICBxYV9mZWVkYmFjayA9IHFhX3JlcG9ydAoKICAgICMgUGhhc2UgMzogRG9jdW1lbnRhdGlvbgogICAgcnVuX2Nvbm5vcl9kb2NzKHJvb3QsIHByZCwgZmluYWxfbG9vcCkKCiAgICAjIEZpbmFsIHN0YXR1cwogICAgc3RhdHVzID0gJ2NvbXBsZXRlZCcgaWYgY29tcGxldGUgZWxzZSAnYmxvY2tlZCcKICAgIG1lc3NhZ2UgPSAiRG9uZSEiIGlmIGNvbXBsZXRlIGVsc2UgIk5lZWRzIGF0dGVudGlvbiIKICAgIHNlbmRfd2ViaG9vayhzdGF0dXMsIG1lc3NhZ2UsICdjb25ub3InLCAnY29tcGxldGUnLCBmaW5hbF9sb29wKQoKICAgICMgR2l0IGNvbW1pdAogICAgbG9nKCJcbvCfk6YgQ29tbWl0dGluZyBjaGFuZ2VzLi4uIikKICAgIHN1YnByb2Nlc3MucnVuKFsnZ2l0JywgJ2NvbmZpZycsICd1c2VyLmVtYWlsJywgJ2ZsdXhnZW5AZXhhbXBsZS5jb20nXSwgY3dkPXN0cihyb290KSkKICAgIHN1YnByb2Nlc3MucnVuKFsnZ2l0JywgJ2NvbmZpZycsICd1c2VyLm5hbWUnLCAnRmx1eEdlbiBCb3QnXSwgY3dkPXN0cihyb290KSkKICAgIHN1YnByb2Nlc3MucnVuKFsnZ2l0JywgJ2FkZCcsICctQSddLCBjd2Q9c3RyKHJvb3QpKQogICAgcmVzdWx0ID0gc3VicHJvY2Vzcy5ydW4oCiAgICAgICAgWydnaXQnLCAnY29tbWl0JywgJy1tJywgJ2ZlYXQ6IEZsdXhHZW4gaW1wbGVtZW50YXRpb24gKE1PQ0spJ10sCiAgICAgICAgY3dkPXN0cihyb290KSwgY2FwdHVyZV9vdXRwdXQ9VHJ1ZSwgdGV4dD1UcnVlCiAgICApCiAgICBsb2coZiJbR2l0XSB7cmVzdWx0LnN0ZG91dH0ge3Jlc3VsdC5zdGRlcnJ9IikKCiAgICBsb2coIlxu4pyFIE1vY2sgUGlwZWxpbmUgY29tcGxldGUhIiBpZiBjb21wbGV0ZSBlbHNlICJcbuKaoO+4jyBNb2NrIFBpcGVsaW5lIG5lZWRzIGF0dGVudGlvbiIpCgppZiBfX25hbWVfXyA9PSAnX19tYWluX18nOgogICAgbWFpbigpCg==" | base64 -d > fluxgen_pipeline.py

      - name: Run Mock Pipeline
        env:
          PROJECT_ID: ${{ inputs.project_id }}
          CALLBACK_URL: ${{ inputs.callback_url }}
          MAX_LOOPS: ${{ inputs.max_loops }}
          STEP_DELAY: ${{ inputs.step_delay }}
          PYTHONUNBUFFERED: "1"
        run: python3 -u fluxgen_pipeline.py

      - name: Push changes
        run: git push origin HEAD
